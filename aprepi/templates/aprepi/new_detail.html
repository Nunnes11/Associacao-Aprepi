{% extends 'aprepi/base_clear.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/news_detail.css' %}">

<div class="news-detail-container container mt-4">
  <h2>{{ new.title }}</h2>

  <img src="{{ new.image.url }}" class="img-fluid mb-3" alt="Imagem da notícia"
    style="max-height: 400px; object-fit: cover;">

  <div class="news-text">
    <p>{{ new.text|linebreaks }}</p>
  </div>

  <hr>
  <h5>Comentários</h5>

  {% for comment in comments %}
  <div class="mb-3 p-3">
    <strong>{{ comment.name }}</strong>
    <small class="text-muted">em {{ comment.created_at|date:"d/m/Y H:i" }}</small>
    <p>{{ comment.comment|linebreaks }}</p>

    <a href="javascript:void(0);" class="text-primary" onclick="toggleReplyForm('{{ comment.id }}')">responder</a>

    {% for reply in comment.replies.all %}
    <div class="ms-4 mt-2 p-2 border-start border-primary">
      <strong>{{ reply.name }}</strong>
      <small class="text-muted">em {{ reply.created_at|date:"d/m/Y H:i" }}</small>
      <p>{{ reply.reply|linebreaks }}</p>
    </div>
    {% endfor %}

    <div id="reply-form-{{ comment.id }}" class="mt-2 ms-4" style="display: none;">
      <form method="post">
        {% csrf_token %}
        <p><strong>Respondendo como:</strong>
          {% if request.session.user_name %}
          {{ request.session.user_name }}
          {% elif user.is_authenticated %}
          {{ user.username }}
          {% else %}
          Anônimo
          {% endif %}
        </p>

        <p>
          <label for="id_reply_{{ comment.id }}">Responder:</label>
          <textarea name="reply" cols="40" rows="2" required id="id_reply_{{ comment.id }}"
            class="form-control"></textarea>
        </p>

        <input type="hidden" name="comment_id" value="{{ comment.id }}">
        <button type="submit" name="reply_submit" class="btn btn-sm btn-outline-primary">Responder</button>
        <button type="button" class="btn btn-sm btn-outline-secondary"
          onclick="toggleReplyForm('{{ comment.id }}')">Cancelar</button>
      </form>
    </div>
  </div>
  {% endfor %}

  <hr>

  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" name="comment_submit" class="btn btn-primary">Enviar</button>
  </form>

  <a href="{% url 'news_list' %}" class="btn btn-secondary mt-3">← Saiu na Imprensa</a>
  <a href="{% url 'reception_page' %}" class="btn btn-primary mt-3">Página inicial</a>
</div>
{% endblock content %}
